<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>alysa – Intelligent planering</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; }
    .gradient-text {
      background: linear-gradient(135deg, #0f172a 0%, #4f46e5 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
  </style>
</head>

<body class="bg-white text-slate-900 selection:bg-indigo-100">

  <!-- NAV -->
  <nav class="max-w-7xl mx-auto px-6 py-6 flex justify-between items-center">
    <a href="./" class="flex items-center">
      <img src="./alysa-logo.png" alt="alysa" class="h-8 w-auto opacity-90 hover:opacity-100 transition" />
    </a>
  </nav>

  <!-- HERO -->
  <main class="relative px-6">
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-50/60 via-white to-white -z-10"></div>

    <!-- UPLOAD SECTION -->
    <section class="max-w-3xl mx-auto text-center pt-20">
      <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight mb-6">
        Snabba krav. <span class="gradient-text">Omedelbart.</span>
      </h1>

      <p class="text-lg text-slate-500 mb-10">
        Ladda upp ett upphandlings- eller byggdokument och identifiera krav direkt.
      </p>

      <!-- DROPZONE -->
      <div
        id="dropzone"
        class="flex flex-col items-center justify-center p-10 border-2 border-dashed border-slate-300 rounded-3xl cursor-pointer hover:border-indigo-500 transition bg-white/70"
      >
        <p class="font-medium text-slate-700">Dra in en PDF här eller klicka för att välja</p>
        <p class="text-sm text-slate-400 mt-2">Endast PDF • Lokal analys</p>
        <input id="fileInput" type="file" accept="application/pdf" class="hidden" />
      </div>

      <!-- STATUS -->
      <p id="uploadStatus" class="mt-6 text-sm text-slate-500"></p>
    </section>

    <!-- RESULTS -->
    <section id="results" class="max-w-3xl mx-auto mt-20 hidden">
      <h2 class="text-2xl font-bold mb-8 text-center">
        Identifierade krav
      </h2>

      <ul id="requirementsList" class="space-y-6"></ul>

      <div class="flex justify-center">
        <button
          id="downloadJsonBtn"
          class="mt-10 px-6 py-3 bg-slate-900 text-white rounded-xl hover:bg-indigo-600 transition hidden"
        >
          Ladda ner JSON
        </button>
      </div>
    </section>
  </main>

  <!-- SCRIPT -->
  <script>
    const API_URL = "http://127.0.0.1:8000/api/upload-pdf";

    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const status = document.getElementById("uploadStatus");
    const results = document.getElementById("results");
    const requirementsList = document.getElementById("requirementsList");
    const downloadJsonBtn = document.getElementById("downloadJsonBtn");

    let lastPdfResult = null;

    dropzone.addEventListener("click", () => fileInput.click());

    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.classList.add("border-indigo-500");
    });

    dropzone.addEventListener("dragleave", () => {
      dropzone.classList.remove("border-indigo-500");
    });

    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("border-indigo-500");
      handleFile(e.dataTransfer.files[0]);
    });

    fileInput.addEventListener("change", () => {
      handleFile(fileInput.files[0]);
    });

    function badgeClass(type) {
      if (type === "SKALL") {
        return "bg-red-100 text-red-700 border border-red-200";
      }
      if (type === "BÖR") {
        return "bg-blue-100 text-blue-700 border border-blue-200";
      }
      return "bg-slate-100 text-slate-600";
    }

    function handleFile(file) {
      if (!file || file.type !== "application/pdf") {
        status.textContent = "❌ Välj en giltig PDF-fil.";
        return;
      }

      status.textContent = "⏳ Laddar upp och analyserar PDF…";
      requirementsList.innerHTML = "";
      results.classList.add("hidden");
      downloadJsonBtn.classList.add("hidden");

      const formData = new FormData();
      formData.append("file", file);

      fetch(API_URL, {
        method: "POST",
        body: formData
      })
        .then(res => {
          if (!res.ok) throw new Error("Upload failed");
          return res.json();
        })
        .then(data => {
          lastPdfResult = data;

          status.textContent =
            `✅ Klar! ${data.page_count} sidor analyserade` +
            (data.used_ocr ? " (OCR användes)" : "");

          renderRequirements(data.requirements || []);
          results.classList.remove("hidden");
          downloadJsonBtn.classList.remove("hidden");
        })
        .catch(err => {
          console.error(err);
          status.textContent = "❌ Något gick fel vid uppladdning.";
        });
    }

    function renderRequirements(requirements) {
      if (requirements.length === 0) {
        requirementsList.innerHTML =
          `<li class="text-center text-slate-500">Inga krav identifierades.</li>`;
        return;
      }

      requirements.forEach(req => {
        const li = document.createElement("li");
        li.className = "relative bg-white rounded-2xl p-6 shadow-sm border border-slate-200";

        li.innerHTML = `
          <span class="absolute top-4 right-4 px-3 py-1 text-xs font-semibold rounded-full ${badgeClass(req.classification)}">
            ${req.classification}
          </span>

          <p class="text-slate-900 text-base leading-relaxed pr-20">
            ${req.text}
          </p>

          <p class="mt-3 text-sm text-slate-500">
            Sida ${req.page} • ${req.source.toUpperCase()} • ${req.id}
          </p>
        `;

        requirementsList.appendChild(li);
      });
    }

    downloadJsonBtn.addEventListener("click", () => {
      if (!lastPdfResult) return;

      const blob = new Blob(
        [JSON.stringify(lastPdfResult, null, 2)],
        { type: "application/json" }
      );

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = lastPdfResult.filename.replace(".pdf", "") + "_requirements.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>

</body>
</html>
